@page
@using System.Collections
@model KamiYomu.Web.Areas.Settings.Pages.AuditTrail.IndexModel
@inject IConfiguration Configuration
@section Styles {
    <link rel="stylesheet" href="~/lib/xterm/xterm.min.css" />
}
@section Scripts {
    <script src="~/lib/xterm/xterm.js" type="text/javascript"></script>
    <script src="~/lib/xterm/addon-fit/lib/addon-fit.js" type="text/javascript"></script>
    <script>
        const term = new Terminal({
            convertEol: true,
            fontFamily: "monospace",
            theme: {
                background: "#1e1e1e",
                foreground: "#cccccc"
            }
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById("terminal"));
        fitAddon.fit();

        const eventSource = new EventSource("/Settings/AuditTrail/Index?handler=LogStream");

        eventSource.onmessage = (e) => {
            let line = e.data;
        if (line.includes("ERR")) line = `\x1b[31m${line}\x1b[0m`; 
        if (line.includes("FTL")) line = `\x1b[31m${line}\x1b[0m`; 
        if (line.includes("WRN")) line = `\x1b[33m${line}\x1b[0m`; 
        if (line.includes("INF")) line = `\x1b[36m${line}\x1b[0m`; 
            term.writeln(line);
        };
    </script>

}

@{

    string[] allowedPrefixes = { "SpecialFolders", "UI", "Worker" };

    var filteredSettings = Configuration.AsEnumerable()
        .Where(c => allowedPrefixes.Any(p => c.Key.StartsWith(p)))
        .OrderBy(c => c.Key);
}

<div class="d-flex justify-content-between align-items-center m-3">
    <h2 class="h5 mb-0 text-primary">
        <i class="bi bi-body-text me-3" aria-hidden="true"></i>
        @I18n.System
    </h2>
</div>
<div class="container-fluid p-4">
    <!-- System Information Panel -->
    <div class="mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle me-2"></i>@I18n.SystemInformation
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@I18n.ProcessorCount</span>
                        <span>
                            @Environment.ProcessorCount
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@I18n.MachineName</span>
                        <span>@Environment.MachineName</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@I18n.OperationalSystemVersion</span>
                        <span>@Environment.OSVersion</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@I18n.FrameworkVersion</span>
                        <span>@System.Runtime.InteropServices.RuntimeInformation.FrameworkDescription</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@I18n.Architecture</span>
                        <span>@System.Runtime.InteropServices.RuntimeInformation.OSArchitecture</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@I18n.CurrentDirectory</span>
                        <span>@Environment.CurrentDirectory</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Log Stream / Terminal -->
    <div>
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-light">
                <i class="bi bi-terminal me-2"></i>@I18n.LogStream
            </div>
            <div class="card-body p-0">
                <div id="terminal" class="bg-dark text-light p-3 overflow-auto" style="height:400px;">
                    <!-- Logs will stream here -->
                </div>
            </div>
        </div>
    </div>
</div>

