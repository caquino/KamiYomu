@using KamiYomu.Web.Entities
@using KamiYomu.Web.Extensions
@using System.Text
@model ChapterDownloadRecord
@{
    var rowId = $"row-{Model.Id}";
    var badgeClass = Model.DownloadStatus switch
    {
        Entities.Definitions.DownloadStatus.Completed => "bg-success",
        Entities.Definitions.DownloadStatus.Cancelled => "bg-danger",
        Entities.Definitions.DownloadStatus.Scheduled => "bg-primary",
        Entities.Definitions.DownloadStatus.InProgress => "bg-info",
        _ => "bg-secondary"
    };
    var lastUpdateBuilder = new StringBuilder();
    lastUpdateBuilder.AppendLine($"{I18n.LastUpdate}: {Model.StatusUpdateAt?.ToLocalTime()}.");
    if (!string.IsNullOrWhiteSpace(Model.StatusReason))
    {
        lastUpdateBuilder.AppendLine(Model.StatusReason);
    }
}
<tr id="@rowId">
    <td>@Model.Chapter.GetCbzFileName()</td>
    <td>@Model.Chapter.GetCbzFileSize()</td>
    <td>
        <span class="badge @badgeClass" title="@lastUpdateBuilder.ToString()"
              data-bs-toggle="popover"
              data-bs-trigger="hover focus"
              data-bs-placement="top"
              data-bs-content="@lastUpdateBuilder.ToString()">
            @(I18n.ResourceManager.GetString(Model.DownloadStatus.ToString())
                        ?? Model.DownloadStatus.ToString())
        </span>
    </td>
    <td>@Model.CreateAt.ToLocalTime().ToString("g")</td>
    <td class="text-end">
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-gear"></i> @I18n.Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <!-- Reschedule -->
                <li>
                    <form method="post"
                          hx-post='@Url.Page("DownloadChapterTable",
                                                                         values: new { handler = "Reschedule", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })'
                          hx-target="#@rowId"
                          hx-swap="outerHTML">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="dropdown-item d-flex align-items-center gap-2"
                                @(Model.IsCompleted() || Model.IsCancelled() ? "" : "disabled")>
                            <i class="bi bi-arrow-repeat"></i> @I18n.Reschedule
                        </button>
                    </form>
                </li>

                <!-- Download -->
                <!-- Download .Cbz -->
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2 @( (Model?.IsCompleted() ?? false) ? "" : "disabled" )"
                       href="@( (Model?.IsCompleted() ?? false)
                                              ? Url.Page("DownloadChapterTable",
                                                         values: new { handler = "DownloadCbz", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })
                                              : "#" )"
                       target="_blank"
                       aria-disabled="@( (Model?.IsCompleted() ?? false) ? "false" : "true" )">
                        <i class="bi bi-download"></i> @I18n.Download .Cbz <i class="bi bi-file-earmark-zip-fill"></i>
                    </a>
                </li>

                <!-- Download .Zip -->
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2 @( (Model?.IsCompleted() ?? false) ? "" : "disabled" )"
                       href="@( (Model?.IsCompleted() ?? false)
                                              ? Url.Page("DownloadChapterTable",
                                                         values: new { handler = "DownloadZip", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })
                                              : "#" )"
                       target="_blank"
                       aria-disabled="@( (Model?.IsCompleted() ?? false) ? "false" : "true" )">
                        <i class="bi bi-download"></i> @I18n.Download .Zip <i class="bi bi-file-zip-fill"></i>
                    </a>
                </li>

                <!-- Download .Pdf -->
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2 @( (Model?.IsCompleted() ?? false) ? "" : "disabled" )"
                       href="@( (Model?.IsCompleted() ?? false)
                                              ? Url.Page("DownloadChapterTable",
                                                         values: new { handler = "DownloadPdf", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })
                                              : "#" )"
                       target="_blank"
                       aria-disabled="@( (Model?.IsCompleted() ?? false) ? "false" : "true" )">
                        <i class="bi bi-download"></i> @I18n.Download .Pdf <i class="bi bi-file-pdf-fill"></i>
                    </a>
                </li>

                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2"
                       href="@Model.Chapter.Uri"
                       target="_blank"
                       aria-disabled="false">
                        <i class="bi bi-link-45deg"></i> @I18n.Source <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </li>

                <!-- Cancel -->
                <li>
                    <form method="post"
                          hx-post='@Url.Page("DownloadChapterTable", new { handler = "Cancel", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })'
                          hx-target="#@rowId"
                          hx-swap="outerHTML">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="dropdown-item d-flex align-items-center gap-2"
                                @(Model.IsInProgress() ? "" : "disabled")>
                            <i class="bi bi-x-circle"></i> @I18n.Cancel
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </td>
</tr>