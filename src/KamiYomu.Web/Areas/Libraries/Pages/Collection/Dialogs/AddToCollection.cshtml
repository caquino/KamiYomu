@page
@using KamiYomu.Web.AppOptions
@using KamiYomu.Web.Extensions
@using Microsoft.Extensions.Options
@model KamiYomu.Web.Areas.Libraries.Pages.Collection.Dialogs.AddToCollectionModel
@{
    Layout = null;

    var titlePreviewUrl = Url.Page(
        "/Collection/Dialogs/AddToCollection",
        "Preview",
        new { area = "Libraries" }
    );

    var comicInfoPreviewUrl = Url.Page(
    "/Collection/Dialogs/AddToCollection",
    "ComicInfoPreview",
    new { area = "Libraries" }
);
}
<div class="modal-header">
    <h5 class="modal-title">@I18n.AddToYourCollection</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body" id="addToCollectionModal">
    <vc:manga-info manga="@Model.Manga" />

    <form method="post"
          hx-post="@Url.Page("/Downloads/Index", "AddToCollection", new { area = "Libraries"})"
          hx-target="#@Model.RefreshElementId"
          hx-swap="innerHTML">

        <div class="accordion mt-3" id="mangaDetailsAccordion">
            <div class="accordion-item border-0 shadow-sm">
                <h2 class="accordion-header" id="mangaDetailsAccordionTitle">
                    <button class="accordion-button collapsed fw-bold"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseMangaDetailsAccordion">
                        <i class="bi bi-gear-wide-connected me-2"></i> @I18n.SetUpYourDownload
                    </button>
                </h2>

                <div id="collapseMangaDetailsAccordion"
                     class="accordion-collapse collapse"
                     data-bs-parent="#mangaDetailsAccordion">
                    <div class="accordion-body px-2 px-sm-3">

                        <p class="small text-muted mb-4">
                            <i class="bi bi-info-circle me-1"></i> @I18n.SetUpYourDownloadDetails
                        </p>

                        <div class="card mb-4 border-light shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0">@I18n.MergeFolders</h6>
                            </div>
                            <div class="card-body">
                                <span class="text-muted">
                                    @I18n.MergeFoldersDetails
                                </span>

                                <vc:manga-template-selector file-path-template-selector="input[name='@Html.NameFor(m => m.FilePathTemplate)']"
                                                            comic-info-series-template-selector="input[name='@Html.NameFor(m => m.ComicInfoSeriesTemplate)']"
                                                            comic-info-title-template-selector="input[name='@Html.NameFor(m => m.ComicInfoTitleTemplate)']" />
                            </div>
                        </div>

                        <div class="card mb-4 border-light shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0">@I18n.FilePathFormat</h6>
                            </div>
                            <div class="card-body">
                                <div class="input-group">
                                    <span class="input-group-text d-none d-sm-block"><i class="bi bi-folder"></i></span>
                                    <input class="form-control"
                                           data-default="@Model.FilePathTemplate"
                                           id="file-path-template-input"
                                           name="FilePathTemplate"
                                           value="@Model.FilePathTemplate"
                                           placeholder="@Model.FilePathTemplate"
                                           hx-post="@titlePreviewUrl"
                                           hx-trigger="keyup changed delay:300ms"
                                           hx-target="#template-preview"
                                           hx-swap="innerHTML"
                                           hx-include="closest form" />
                                    <button type="button" 
                                            class="btn btn-outline-secondary" 
                                            hx-on:click="resetfilePathTemplate()">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                                <div class="form-text mt-2 small">@I18n.FilePathFormatDetails</div>

                                <div id="template-preview" class="mt-2 p-2 rounded border-start border-primary border-4 small">
                                    <partial name="_PathTemplatePreview" model="@Model.TemplateResults" />
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4 border-light shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0">ComicInfo.xml</h6>
                            </div>
                            <div class="card-body">
                                <label class="small fw-semibold text-muted mb-1">@I18n.Title</label>
                                <div class="input-group mb-3">
                                    <input class="form-control"
                                           id="comic-info-title-template-input"
                                           data-default="@Model.ComicInfoTitleTemplate"
                                           name="ComicInfoTitleTemplate"
                                           value="@Model.ComicInfoTitleTemplate"
                                           hx-post="@comicInfoPreviewUrl"
                                           hx-trigger="keyup changed delay:300ms"
                                           hx-target="#comicinfo-template-preview"
                                           hx-include="closest form" />
                                    <button type="button" class="btn btn-outline-secondary" hx-on:click="resetComicInfoTitleTemplate()">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>

                                <label class="small fw-semibold text-muted mb-1">@I18n.Series</label>
                                <div class="input-group mb-2">
                                    <input class="form-control"
                                           id="comic-info-series-template-input"
                                           data-default="@Model.ComicInfoSeriesTemplate"
                                           name="ComicInfoSeriesTemplate"
                                           value="@Model.ComicInfoSeriesTemplate"
                                           hx-post="@comicInfoPreviewUrl"
                                           hx-trigger="keyup changed delay:300ms"
                                           hx-target="#comicinfo-template-preview"
                                           hx-include="closest form" />
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            hx-on:click="resetComicInfoSeriesTemplate()">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>

                                <div id="comicinfo-template-preview" class="mt-3 p-2 rounded border-start border-info border-4 small">
                                    <partial name="_ComicInfoTemplatePreview" model="@Model.ComicInfoTemplateViewModel" />
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <partial name="_PathTemplateVariables" model="@Model.Variables" />
                        </div>

                        <div class="form-check form-switch p-3 bg-primary-subtle rounded border border-primary-subtle d-flex align-items-center">
                            <input class="form-check-input ms-0 me-3" type="checkbox" asp-for="MakeThisConfigurationDefault" id="flexCheckDefault">
                            <label class="form-check-label small fw-semibold" for="flexCheckDefault">
                                @I18n.MakeThisTheDefaultSettingForFutureCollections
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="MangaId" />
        <input type="hidden" asp-for="CrawlerAgentId" />
        <input type="hidden" asp-for="RefreshElementId" />

        <div class="modal-footer flex-column flex-sm-row gap-2 px-0 pt-4">
            <button type="submit" class="btn btn-success btn-lg w-100 flex-sm-fill" data-bs-dismiss="modal">
                <i class="bi bi-plus-circle me-1"></i> @I18n.Add
            </button>
            <button type="button" class="btn btn-outline-secondary w-100 flex-sm-fill" data-bs-dismiss="modal">
                @I18n.Cancel
            </button>
        </div>
    </form>
</div>

<script src="~/js/libraries/add-to-collection.js" asp-append-version="true"></script>
