@page
@using KamiYomu.Web.AppOptions
@using KamiYomu.Web.Extensions
@using Microsoft.Extensions.Options
@model KamiYomu.Web.Areas.Libraries.Pages.Collection.Dialogs.AddToCollectionModel
@{
    Layout = null;

    var titlePreviewUrl = Url.Page(
        "/Collection/Dialogs/AddToCollection",
        "Preview",
        new { area = "Libraries" }
    );

    var comicInfoPreviewUrl = Url.Page(
    "/Collection/Dialogs/AddToCollection",
    "ComicInfoPreview",
    new { area = "Libraries" }
);
}
<div class="modal-header">
    <h5 class="modal-title">@I18n.AddToYourCollection</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body" id="addToCollectionModal">
    <partial name="_MangaInfo" model="Model.Manga" />
    <form method="post"
          hx-post="/Libraries/Downloads/Index?handler=AddToCollection"
          hx-target="#@Model.RefreshElementId"
          hx-swap="innerHTML">
        <div class="accordion mt-4" id="mangaDetailsAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="mangaDetailsAccordionTitle">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseMangaDetailsAccordion">
                        <i class="bi bi-gear-wide me-2"></i> @I18n.SetUpYourDownload
                    </button>
                </h2>

                <div id="collapseMangaDetailsAccordion"
                     class="accordion-collapse collapse"
                     data-bs-parent="#templateVariablesAccordion">
                    <div class="accordion-body">
                        <div class="form-text">
                            @I18n.SetUpYourDownloadDetails
                        </div>

                        <fieldset class="mt-4 border rounded p-3">
                            <legend class="float-none w-auto px-2">@I18n.FilePathFormat</legend>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-braces"></i>
                                </span>

                                <input class="form-control"
                                       id="file-path-template-input"
                                       name="FilePathTemplate"
                                       value="@Model.FilePathTemplate"
                                       placeholder="@Model.FilePathTemplate"
                                       hx-post="@titlePreviewUrl"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#template-preview"
                                       hx-swap="innerHTML"
                                       hx-include="closest form" />

                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        title="Reset to default"
                                        hx-on:click="resetfilePathTemplate()">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>

                            </div>
                            <div class="form-text">
                                @I18n.FilePathFormatDetails
                            </div>

                            <div id="template-preview" class="mt-3">
                                @await Html.PartialAsync("_PathTemplatePreview", Model.TemplateResults)
                            </div>
                        </fieldset>

                        <fieldset class="mt-4 border rounded p-3">
                            <legend class="float-none w-auto px-2">ComicInfo.xml</legend>
                            <div class="input-group mt-1">
                                <span class="input-group-text">
                                    <i class="bi bi-braces me-2"></i> @I18n.Title
                                </span>

                                <input class="form-control"
                                       id="comic-info-title-template-input"
                                       name="ComicInfoTitleTemplate"
                                       value="@Model.ComicInfoTitleTemplate"
                                       placeholder="@Model.ComicInfoTitleTemplate"
                                       hx-post="@comicInfoPreviewUrl"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#comicinfo-template-preview"
                                       hx-swap="innerHTML"
                                       hx-include="closest form" />

                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        title="Reset to default"
                                        hx-on:click="resetComicInfoTitleTemplate()">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                @I18n.TitleFormatDetails
                            </div>

                            <div class="input-group mt-1">
                                <span class="input-group-text">
                                    <i class="bi bi-braces me-2"></i> @I18n.Series
                                </span>

                                <input class="form-control"
                                       id="comic-info-series-template-input"
                                       name="ComicInfoSeriesTemplate"
                                       value="@Model.ComicInfoSeriesTemplate"
                                       placeholder="@Model.ComicInfoSeriesTemplate"
                                       hx-post="@comicInfoPreviewUrl"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#comicinfo-template-preview"
                                       hx-swap="innerHTML"
                                       hx-include="closest form" />

                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        title="Reset to default"
                                        hx-on:click="resetComicInfoSeriesTemplate()">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                @I18n.SeriesFormatDetails
                            </div>
                            <div id="comicinfo-template-preview" class="mt-3">
                                @await Html.PartialAsync("_ComicInfoTemplatePreview", Model.ComicInfoTemplateViewModel)
                            </div>
                        </fieldset>

                        <div>
                            @await Html.PartialAsync("_PathTemplateVariables", Model.Variables)
                        </div>

                        <div class="form-check d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" asp-for="MakeThisConfigurationDefault" id="flexCheckDefault">
                            <label class="form-check-label" for="flexCheckDefault">
                                <i class="bi bi-bookmark-star-fill text-primary me-1"></i>
                                @I18n.MakeThisTheDefaultSettingForFutureCollections
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="MangaId" />
        <input type="hidden" asp-for="CrawlerAgentId" />
        <input type="hidden" asp-for="RefreshElementId" />
        <input type="hidden" id="default-file-path-format" value="@Model.SpecialFolderOptions.FilePathFormat" />
        <input type="hidden" id="default-comic-info-title-format" value="@Model.SpecialFolderOptions.ComicInfoTitleFormat" />
        <input type="hidden" id="default-comic-info-series-format" value="@Model.SpecialFolderOptions.ComicInfoSeriesFormat" />
        <div class="modal-footer">
            <input type="hidden" id="FilePathTemplate" name="FilePathTemplate" value="@Model.FilePathTemplate" />
            <button type="submit" class="btn btn-success" data-bs-dismiss="modal">@I18n.Add</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@I18n.Cancel</button>
        </div>
    </form>
</div>


<script>
    function resetfilePathTemplate() {
        const input = document.getElementById('file-path-template-input');
        const def = document.getElementById('default-file-path-format');

        if (!input || !def) return;

        input.value = def.value;
        htmx.trigger(input, 'change');
    }

    function resetComicInfoTitleTemplate () {
        const input = document.getElementById('comic-info-title-template-input');
        const def = document.getElementById('default-comic-info-title-format');

        if (!input || !def) return;

        input.value = def.value;
        htmx.trigger(input, 'change');
    }

    function resetComicInfoSeriesTemplate() {
        const input = document.getElementById('comic-info-series-template-input');
        const def = document.getElementById('default-comic-info-series-format');

        if (!input || !def) return;

        input.value = def.value;
        htmx.trigger(input, 'change');
    }
</script>
