@page
@using KamiYomu.Web.Extensions
@using System.Text
@model KamiYomu.Web.Areas.Libraries.Pages.Mangas.Dialogs.DownloadStatusModel
@{
    Layout = null;
    using var crawlerInstance = Model.Library.AgentCrawler.GetCrawlerInstance();
    var faviconUrl = await crawlerInstance.GetFaviconAsync(CancellationToken.None);
    var badgeClass = Model.Record.DownloadStatus switch
    {
        Entities.Definitions.DownloadStatus.ToBeRescheduled => "bg-warning",
        Entities.Definitions.DownloadStatus.Scheduled => "bg-primary",
        Entities.Definitions.DownloadStatus.InProgress => "bg-info",
        Entities.Definitions.DownloadStatus.Completed => "bg-success",
        Entities.Definitions.DownloadStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };
    var lastUpdateBuilder = new StringBuilder();
    lastUpdateBuilder.AppendLine($"{I18n.LastUpdate}: {Model.Record.StatusUpdateAt?.ToLocalTime()}.");
    if (!string.IsNullOrWhiteSpace(Model.Record.StatusReason))
    {
        lastUpdateBuilder.AppendLine(Model.Record.StatusReason);
    }

}
<div class="modal-header">
    <h5 class="modal-title">@I18n.DownloadStatus</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body" id="DownloadStatusContainer">
    <div class="container-fluid">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="border rounded shadow-sm overflow-hidden">
                    <a href="@Model.Library.Manga.WebSiteUrl" alt="@Model.Library.Manga.Title" target="_blank">
                        <img src="@Model.Library.Manga.CoverUrl.ToInternalImageUrl()" alt="@Model.Library.Manga.Title"
                             class="img-fluid w-100" style="object-fit: cover; max-height: 400px;" />
                    </a>
                </div>
            </div>

            <div class="col-md-8">
                <h2 class="fw-bold mb-3">@Model.Library.Manga.Title</h2>

                <div class="mb-3 d-flex align-items-center">
                    <span class="fw-semibold me-2">@I18n.CrawlerAgent:</span>
                    <img src="@faviconUrl.ToInternalImageUrl()" width="20" class="me-2" alt="favicon" />
                    <span class="text-muted">@Model.Library.AgentCrawler.DisplayName</span>
                </div>

                <div class="d-flex align-items-center gap-3 mb-3">

                    <partial name="_FollowButton" model="Model.FollowButtonViewModel" />
                    <div>
                        <label class="form-label fw-semibold mb-0 me-2">
                            @I18n.ChapterSearchStatus:
                        </label>
                        <span class="badge @badgeClass"
                              title="@lastUpdateBuilder.ToString()"
                              data-bs-toggle="popover"
                              data-bs-trigger="hover focus"
                              data-bs-placement="top"
                              data-bs-content="@lastUpdateBuilder.ToString()">
                            @(I18n.ResourceManager.GetString(Model.Record.DownloadStatus.ToString())
                                                        ?? Model.Record.DownloadStatus.ToString())
                        </span>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Download Progress</label>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             role="progressbar"
                             style="width: @Model.Progress.ToString("F0")%;"
                             aria-valuenow="@Model.Progress.ToString("F0")"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            @Model.Progress.ToString("F0")%
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="col-sm-6">
                        <label class="form-label fw-semibold">@I18n.ChaptersFound</label>
                        <div class="form-control-plaintext">@Model.Total</div>
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label fw-semibold">@I18n.Downloaded</label>
                        <div class="form-control-plaintext">@Model.Completed</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion g-4 mt-2" id="downloadAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTable">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseTable"
                            hx-get="@Url.Page("DownloadChapterTable")?libraryId=@Model.Library.Id"
                            hx-trigger="click"
                            hx-target="#collapseTable"
                            hx-swap="innerHTML">
                        @I18n.ChaptersFound
                    </button>
                </h2>
                <div id="collapseTable"
                     class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <div class="text-muted">Loading table…</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
      const popoverTriggerList = [].slice.call(
        document.querySelectorAll('#DownloadStatusContainer [data-bs-toggle="popover"]')
      );
      popoverTriggerList.forEach(function (el) {
        new bootstrap.Popover(el, {
          container: '#DownloadStatusContainer'
        });
      });
    });
</script>