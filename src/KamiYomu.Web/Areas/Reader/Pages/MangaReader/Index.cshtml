@page "{libraryId:guid}/chapter/{chapterDownloadId:guid}"
@using KamiYomu.Web.Areas.Reader.Pages.MangaReader
@model IndexModel

<div id="readerShell" class="reader-shell d-flex flex-column vh-100 overflow-hidden" >

    <div class="main-viewer d-flex flex-column flex-grow-1 overflow-hidden" id="mainViewer">

        <div class="offcanvas offcanvas-start opacity-75 opacity-sm-100"
             tabindex="-1"
             id="readerSettings"
             data-bs-container="#mainViewer">
            <div class="offcanvas-header border-bottom border-secondary">
                <h5 class="offcanvas-title">@I18n.Settings</h5>
                <button type="button" class="btn-close btn-primary" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="offcanvas-body">
                <partial name="Partials/_ReaderControls" />
            </div>
        </div>

        <partial name="Partials/_ReaderHeader" model="Model" />

        <div id="readerContainer" class="webtoon-mode flex-grow-1 overflow-auto bg-black" data-last-page="@Model.LastReadPage">
            @for (int i = 0; i < Model.PageUrls.Count; i++)
            {
                int pageNumber = i + 1;
                bool isLastPage = (i == Model.PageUrls.Count - 1);

                <div class="manga-page-wrapper" 
                     id="manga-page-@(pageNumber)"
                     data-page-index="@(pageNumber)"
                     hx-post="@Url.Page("/MangaReader/Index", "PageViewed", 
                     new { 
                            Area = "Reader",
                            Model.ChapterDownloadId,
                            LibraryId = Model.LibraryId,
                            IsLastPage = isLastPage,
                            PageNumber = pageNumber,
                            ChapterNumber = Model.ChapterDownloaded.Chapter.Number,
                            TotalPages = Model.TotalPages
                     })"
                     hx-trigger="page-passed"
                     hx-swap="none">
                    <img src="@Url.Page("/MangaReader/Index", "Image", new { area = "Reader", Model.ChapterDownloadId, fileName = Model.PageUrls[i] })"
                         class="reader-img"
                         loading="lazy"
                         alt="Page @(i + 1)" />
                </div>
            }


            <div id="end-of-chapter-card" 
                 class="manga-page-wrapper d-flex align-items-center justify-content-center"
                 style="min-height: 100vh; background-color: #1a1a1a;"
                 hx-post="@Url.Page("/MangaReader/Index", "PageViewed", new { Area = "Reader", Model.ChapterDownloadId, IsLastPage = true, PageNumber = Model.TotalPages })"
                 hx-trigger="page-passed"
                 hx-swap="none">
        
                <div class="text-center p-5 border border-secondary rounded bg-dark text-white shadow-lg mx-3" style="max-width: 500px;">
                    <i class="bi bi-check2-circle display-1 text-success mb-3"></i>
                    <h2 class="fw-bold text-uppercase">@I18n.EndOfChapter</h2>
                    <p class="text-secondary mb-4">@I18n.YouHaveReachedTheEndOfTheChapter</p>
            
                    <div class="d-grid gap-2">
                         @if (Model.NextChapterId != null)
                        {
                            <a asp-area="Reader"
                               asp-page="/MangaReader/Index"
                               asp-route-chapterDownloadId="@Model.NextChapterId"
                               asp-route-libraryId="@Model.LibraryId" 
                               class="btn btn-outline-light">
                                 @I18n.NextChapter 
                                 <i class="bi bi-chevron-right ms-2"></i>
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-outline-light"
                                    disabled
                                    aria-disabled="true">
                                    @I18n.NextChapter 
                                 <i class="bi bi-chevron-right ms-2"></i>
                            </button>
                        }
                        
                        <a asp-area="Reader"
                           asp-page="/MangaGallery/Index" class="btn btn-outline-light">
                            <i class="bi bi-grid-3x3-gap me-2"></i> Back to Library
                        </a>
                        
                    </div>
                </div>
            </div>
        </div>

        <partial name="Partials/_ReaderFooter" model="Model" />

    </div>
</div>

@section Scripts {
    <script src="~/js/reader/manga-reader.js" asp-append-version="true"></script>
}
