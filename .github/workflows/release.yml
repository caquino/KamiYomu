name: Release Docker Image

on:
  push:
    branches:
      - 'releases/**'

permissions:
  contents: write
  actions: write
  packages: write

jobs:
  extract_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_outputs.outputs.version }}
      version_suffix: ${{ steps.set_outputs.outputs.version_suffix }}
      is_prerelease: ${{ steps.set_outputs.outputs.is_prerelease }}
      tag: ${{ steps.set_outputs.outputs.tag }}

    steps:
      - name: Extract version and suffix from branch
        id: extract_version
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          RAW_VERSION="${BRANCH_NAME#releases/}"

          if [[ "$RAW_VERSION" == *"-"* ]]; then
            VERSION_BASE="${RAW_VERSION%%-*}"
            VERSION_SUFFIX="-${RAW_VERSION#*-}"
            IS_PRERELEASE=true
          else
            VERSION_BASE="$RAW_VERSION"
            VERSION_SUFFIX=""
            IS_PRERELEASE=false
          fi

          if [[ ! "$VERSION_BASE" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid VERSION_BASE format: '$VERSION_BASE'"
            exit 1
          fi

          TAG="${VERSION_BASE}${VERSION_SUFFIX}"

          echo "VERSION=${VERSION_BASE}" >> $GITHUB_ENV
          echo "VERSION_SUFFIX=${VERSION_SUFFIX}" >> $GITHUB_ENV
          echo "IS_PRERELEASE=${IS_PRERELEASE}" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV

      - name: Set outputs
        id: set_outputs
        run: |
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_suffix=${VERSION_SUFFIX}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

  build:
    name: Build and Push Docker Image
    needs: extract_version
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: marcoscostadev/kamiyomu

    outputs:
      version: ${{ needs.extract_version.outputs.version }}
      version_suffix: ${{ needs.extract_version.outputs.version_suffix }}
      is_prerelease: ${{ needs.extract_version.outputs.is_prerelease }}
      tag: ${{ needs.extract_version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.GH_KAMIYOMU_DOCKERHUB_USERNAME }}
          password: ${{ secrets.GH_KAMIYOMU_DOCKERHUB_TOKEN }}

      # Pre-release (only version tag)
      - name: Build & push multi-arch (pre-release)
        if: ${{ needs.extract_version.outputs.is_prerelease == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: src
          file: src/KamiYomu.Web/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ needs.extract_version.outputs.tag }}
          build-args: |
            VERSION=${{ needs.extract_version.outputs.version }}
            VERSION_SUFFIX=${{ needs.extract_version.outputs.version_suffix }}
            BUILD_CONFIGURATION=Release

      # Stable (version + latest)
      - name: Build & push multi-arch (stable)
        if: ${{ needs.extract_version.outputs.is_prerelease == 'false' }}
        uses: docker/build-push-action@v5
        with:
          context: src
          file: src/KamiYomu.Web/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ needs.extract_version.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            VERSION=${{ needs.extract_version.outputs.version }}
            VERSION_SUFFIX=${{ needs.extract_version.outputs.version_suffix }}
            BUILD_CONFIGURATION=Release

  build_platforms:
    name: Build (${{ matrix.os }} / ${{ matrix.rid }})
    needs: extract_version
    runs-on: ${{ matrix.os }}
    outputs:
      version: ${{ needs.extract_version.outputs.version }}
      version_suffix: ${{ needs.extract_version.outputs.version_suffix }}
      is_prerelease: ${{ needs.extract_version.outputs.is_prerelease }}
      tag: ${{ needs.extract_version.outputs.tag }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows-latest
            rid: win-x64
          - os: windows-latest
            rid: win-x86
          - os: windows-latest
            rid: win-arm64

          # Linux
          - os: ubuntu-latest
            rid: linux-x64
          - os: ubuntu-latest
            rid: linux-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
          
      - name: Restore LibMan tools
        run: dotnet tool restore
        working-directory: ./src

      - name: Restore LibMan libraries
        run: dotnet libman restore
        working-directory: ./src/KamiYomu.Web

      - name: Restore NuGet packages
        run: dotnet restore
        working-directory: ./src

      - name: Publish
        run: >
          dotnet publish ./src/KamiYomu.Web/KamiYomu.Web.csproj
          -c Release
          -r ${{ matrix.rid }}
          --self-contained true
          /p:Version=${{ needs.extract_version.outputs.version }}
          /p:AssemblyVersion=${{ needs.extract_version.outputs.version }}
          /p:FileVersion=${{ needs.extract_version.outputs.version }}
          /p:PublishSingleFile=true
          /p:IncludeNativeLibrariesForSelfExtract=true
          -o publish/${{ matrix.rid }}

      - name: Archive artifact
        shell: bash
        run: |
          cd publish
          tar -czf aspnet-${{ needs.extract_version.outputs.tag }}-${{ matrix.rid }}.tar.gz ${{ matrix.rid }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aspnet-${{ needs.extract_version.outputs.tag }}-${{ matrix.rid }}
          path: publish/aspnet-${{ needs.extract_version.outputs.tag }}-${{ matrix.rid }}.tar.gz

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build_platforms

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create git tag
        run: |
          git tag ${{ needs.build_platforms.outputs.tag }}
          git push origin ${{ needs.build_platforms.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build_platforms.outputs.tag }}
          name: Release ${{ needs.build_platforms.outputs.tag }}
          prerelease: ${{ needs.build_platforms.outputs.is_prerelease || false }}
          files: artifacts/**/*.tar.gz
