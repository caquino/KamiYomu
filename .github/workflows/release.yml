name: Release Docker Image

on:
  push:
    branches:
      - 'releases/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: marcoscostadev/kamiyomu

    outputs:
      version: ${{ steps.set_outputs.outputs.version }}
      version_suffix: ${{ steps.set_outputs.outputs.version_suffix }}
      is_prerelease: ${{ steps.set_outputs.outputs.is_prerelease }}
      tag: ${{ steps.set_outputs.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version and suffix from branch
        id: extract_version
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          RAW_VERSION="${BRANCH_NAME#releases/}"

          if [[ "$RAW_VERSION" == *"-"* ]]; then
            VERSION_BASE="${RAW_VERSION%%-*}"
            VERSION_SUFFIX="-${RAW_VERSION#*-}"
            IS_PRERELEASE=true
          else
            VERSION_BASE="$RAW_VERSION"
            VERSION_SUFFIX=""
            IS_PRERELEASE=false
          fi

          if [[ ! "$VERSION_BASE" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid VERSION_BASE format: '$VERSION_BASE'"
            exit 1
          fi

          TAG="${VERSION_BASE}${VERSION_SUFFIX}"

          echo "VERSION=${VERSION_BASE}" >> $GITHUB_ENV
          echo "VERSION_SUFFIX=${VERSION_SUFFIX}" >> $GITHUB_ENV
          echo "IS_PRERELEASE=${IS_PRERELEASE}" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV

      - name: Set outputs
        id: set_outputs
        run: |
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_suffix=${VERSION_SUFFIX}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.GH_KAMIYOMU_DOCKERHUB_USERNAME }}
          password: ${{ secrets.GH_KAMIYOMU_DOCKERHUB_TOKEN }}

      # Pre-release (only version tag)
      - name: Build & push multi-arch (pre-release)
        if: ${{ env.IS_PRERELEASE == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: src
          file: src/KamiYomu.Web/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          build-args: |
            VERSION=${{ env.VERSION }}
            VERSION_SUFFIX=${{ env.VERSION_SUFFIX }}
            BUILD_CONFIGURATION=Release

      # Stable (version + latest)
      - name: Build & push multi-arch (stable)
        if: ${{ env.IS_PRERELEASE == 'false' }}
        uses: docker/build-push-action@v5
        with:
          context: src
          file: src/KamiYomu.Web/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.TAG }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            VERSION=${{ env.VERSION }}
            VERSION_SUFFIX=${{ env.VERSION_SUFFIX }}
            BUILD_CONFIGURATION=Release
            